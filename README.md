# WokAsyncMessageHandler

Async message producer to use with wok 0.4.4  
Include mix task to generate ecto migrations for messages and partitions.  
Include mix task to generate serializer for ecto schema (your "model").  

The **WokAsyncMessageHandler.Bases.Ecto** module when used (with the 'use' macro)
in another module allows to register messages in a table (autogenerated) of your PG database.  
This table is used as a queue for wok to send your messages asynchronously to your message broker (kafka).
Using it in a SQL transaction in your code garanties your messages reflect exactly
your DB state when they are written to BD and that they will be sent to your message broker later,
 no matter what happens, by wok producer process.  
When a message is registered, its id (autoincremented column by PG, send in wok message headers as "message_id" param)
lets your consumers, when they receive the message, know if they already have processed this message.  
It's an "at least once message dispatch, at least once message delivered and exactly once message processed" flow.  


## Installation

in your mix.exs file, include in deps :
```
[...
  {:wok_async_message_handler, git: "git@gitlab.botsunit.com:msaas/wok_async_message_handler.git"},
...]
```

generate required files:
```
mix wok_async_message_handler.init
```
This will create 2 ecto migrations, a serializers folder and a default message handler:
- WokAsyncMessageHandler.Models.EctoProducerMessage to store messages to send (3 fields : topic, partition, blob)
- WokAsyncMessageHandler.Models.StoppedPartition to store stopped partition (when errors occur) and allow the connection to a monitoring system for example
- lib/message_serializers directory to store message serializers for ecto schema (see below for generation)
- lib/services/wok_async_message_handler.ex where a default message handler is generated for you (YOU NEED TO PARAMETER THIS!!!!! DON'T FORGET!!!)

if need, create your database (mix ecto.create), then run :
```
mix ecto.migrate
```

add to your config file :
```
config :wok, producer: [handler: MyApp.Services.WokAsyncMessageHandler, frequency: 100, number_of_messages: 1000]
```
(replace MyApp.Services.WokAsyncMessageHandler by your generated handler name)

create a serializer for your ecto schema MyAppEctoSchema (example : User Or Any resource mapped to db as a "model"):
```
mix wok_async_message_handler.serializer --schema MyAppEctoSchema
```
Edit the generated serializer to add fields to serialization methods and customize "message_route" and "partition_key" functions to fit your needs. (see below for for detail of a serializer)  

and now you can call functions in your code (be sure to add them always in a SQL transaction):
```
{:ok, message} = MyApp.Services.WokAsyncMessageHandler
                 .create_and_add_rt_notification_to_message_queue(%{session_id: "my_session_id"})
...
my_app_ecto_schema = MyApp.Datastores.PG.get(MyApp.MyAppEctoSchema, 1)
{:ok, message} = MyApp.Services.WokAsyncMessageHandler
                 .create_and_add_message_to_message_queue(my_app_ecto_schema, :created, "my_topic")
```

## test

create a local file in config directory to configure database access (duplicate config/local.exs.example if ok)
```
MIX_ENV=test mix wok_async_message_handler.init
MIX_ENV=test mix ecto.drop
MIX_ENV=test mix ecto.create
MIX_ENV=test mix ecto.migrate
mix espec
```
don't forget to clean your tests after (generated migrations files in priv/repo/migrations)  


## serializers

A serializer has multiple functions :
- **message_versions** : returns the list of supported messages serialization versions.  
You should not have more than 2 (or exceptionnaly 3) supported versions.  
When you want to generate a message, the handler will serialize all versions, using the serialization method for the event.  

- **created|updated|destroyed|[your event]** :  
serialization methods for events.
It takes two params (your ecto schema with data, and a version).  
You just need to define the map to return for json serialization.  

- **partition_key** :
THIS MUST RETURN A STRING.  
Returns the partition key for kafka. Often your ID or MASTER_ID.  
If you return an integer, it will be send to this partition number, but this behavior is not wanted here.  

- **message_route** :
the 'to' field in your message.  
